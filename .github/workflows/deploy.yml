name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: ๐ Deploy LolTimeFlash (Monorepo)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ LolTimeFlash - Production Deploy"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo ""

            # Navigate to project
            cd teczer-deployement/LolTimeFlash
            echo "๐ Current directory: $(pwd)"
            echo ""

            # Pull latest changes
            echo "โฌ๏ธ  Pulling latest changes from main..."
            sudo git pull origin main
            echo "โ Git pull completed"
            echo ""

            # Stop running containers
            echo "๐ Stopping running containers..."
            sudo docker compose down
            echo "โ Containers stopped"
            echo ""

            # Clean old images (optional, comment if you want to keep cache)
            echo "๐งน Cleaning old Docker images..."
            sudo docker system prune -f
            echo "โ Cleanup completed"
            echo ""

            # Build new images
            echo "๐จ Building Docker images..."
            sudo docker compose build
            echo "โ Build completed"
            echo ""

            # Start containers
            echo "โถ๏ธ  Starting containers..."
            sudo docker compose up -d
            echo "โ Containers started"
            echo ""

            # Wait for services to be ready
            echo "โณ Waiting for services to be ready (15s)..."
            sleep 15
            echo ""

            # Health checks
            echo "๐ฅ Running health checks..."

            API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8888/monitoring/health 2>/dev/null || echo "000")
            if [ "$API_STATUS" = "200" ]; then
              echo "โ API Health: OK (HTTP 200)"
            else
              echo "โ API Health: FAILED (HTTP $API_STATUS)"
            fi

            WEB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:6333 2>/dev/null || echo "000")
            if [ "$WEB_STATUS" = "200" ]; then
              echo "โ Web Health: OK (HTTP 200)"
            else
              echo "โ Web Health: FAILED (HTTP $WEB_STATUS)"
            fi

            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ Services Status"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            sudo docker compose ps
            echo ""

            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ Deployment Complete!"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo ""
            echo "๐ Services:"
            echo "   โข API:  http://localhost:8888"
            echo "   โข Docs: http://localhost:8888/api/docs"
            echo "   โข Web:  http://localhost:6333"
            echo ""
            echo "๐ Useful Commands:"
            echo "   โข View logs:    sudo docker compose logs -f"
            echo "   โข Restart:      sudo docker compose restart"
            echo "   โข Stop:         sudo docker compose down"
            echo ""
